<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>客户转化漏斗图表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top left, #eff6ff 0, #f9fafb 40%, #f3f4f6 100%);
      color: #111827;
      min-height: 100vh;
      display: flex;
    }
    /* 左侧导航菜单样式 */
    .sidebar {
      width: 240px;
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 24px;
      padding-left: 12px;
    }
    .nav-item {
      display: block;
      padding: 10px 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      color: #4b5563;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
    }
    .nav-item:hover {
      background: #f3f4f6;
      color: #111827;
    }
    .nav-item.active {
      background: #eff6ff;
      color: #2563eb;
      font-weight: 600;
    }

    /* 主内容区域样式 */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }
    .page {
      max-width: 1120px;
      margin: 0 auto;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .page-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .page-subtitle {
      margin-top: 4px;
      font-size: 12px;
      color: #6b7280;
    }
    .page-badge {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(59, 130, 246, 0.06);
      color: #2563eb;
      font-size: 11px;
      border: 1px solid rgba(191, 219, 254, 0.9);
    }
    .card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 14px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.06),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      padding: 16px 18px 18px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #111827;
    }
    .card-caption {
      font-size: 12px;
      color: #6b7280;
    }
    .hint {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }
    .chart-wrapper {
      margin-top: 8px;
      border-radius: 10px;
      background: linear-gradient(145deg, #f9fafb, #eef2ff);
      padding: 10px 10px 6px;
    }
    #funnel {
      width: 100%;
      height: 520px;  /* 增加高度以避免标签拥挤 */
    }
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      .card {
        padding: 14px 12px 16px;
      }
      #funnel {
        height: 520px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <!-- 左侧导航 -->
  <aside class="sidebar">
    <div class="sidebar-title">数据看板</div>
    <nav>
      <a href="客户阶段漏斗数据20260128.html" class="nav-item active">客户转化漏斗</a>
      <a href="industry_pie_chart.html" class="nav-item">客户行业分布</a>
      <a href="industry_income_bar_chart.html" class="nav-item">行业收入分布</a>
      <a href="industry_penetration_stacked_bar.html" class="nav-item">行业渗透分析</a>
    </nav>
  </aside>

  <!-- 主内容 -->
  <main class="main-content">
    <div class="page">
      <header class="page-header">
      <div>
        <div class="page-title">客户漏斗图表</div>
        <p class="page-subtitle">根据截图表格数据绘制 · 轻量看板风</p>
      </div>
      <span class="page-badge">百度地图开放平台 · CRM 漏斗</span>
    </header>

    <section class="card" aria-label="客户转化漏斗">
      <div class="card-header">
        <div class="card-title">客户转化漏斗（真实数据）</div>
        <div class="card-caption">单位：客户数量 / 转化率（%）</div>
      </div>
      <p class="hint">说明：阶段转化 &gt; 100% 代表该阶段相较上一阶段存在“回升 / 补录 / 口径差异”等情况。</p>

      <div class="chart-wrapper">
        <div id="funnel"></div>
      </div>
    </section>
  </div>

  <script>
    const el = document.getElementById('funnel');
    const chart = echarts.init(el);

    // 来自截图表格的数据
    const raw = [
      { name: '注册客户总数', total: 3299607, stage: null, overall: null },
      { name: '提交过认证的客户数', total: 1025632, stage: 31.08, overall: null },
      { name: '认证通过的客户数', total: 974034, stage: 94.97, overall: 29.52 },
      { name: '有调用量的客户数', total: 585351, stage: 60.1, overall: null },
      { name: '提交过商用申请的客户数', total: 9141, stage: 1.56, overall: 0.94 }, // 回升
      { name: '商用申请通过的客户数', total: 6082, stage: 66.54, overall: 0.62 },
      { name: '付费客户数（UID去重）', total: 4713, stage: 77.49, overall: 0.48 },
      { name: '续费客户数(≥2次付费)', total: 2182, stage: 46.3, overall: 0.22 },
    ];

    // 浅色系配色（更偏淡雅）
    const colors = [
      '#E5F0FF',
      '#E0F7FF',
      '#FFF4E1',
      '#FFE6F0',
      '#ECE9FF',
      '#E3F4FF',
      '#E6F8ED'
    ];

    const fmtPct = (v) => (v == null ? '—' : `${Number(v).toFixed(2)}%`);
    const fmtNum = (v) => Number(v).toLocaleString();

    // 右侧“数据概览”展示用：补齐缺失的总转化率（默认相对第一层），并保留原表给出的阶段转化率/总转化率
    const rawWithRates = raw.map((d, i) => {
      const baseTotal = raw[0]?.total ?? 0;
      const overall = d.overall ?? (baseTotal ? (d.total / baseTotal) * 100 : null);
      return { ...d, overall };
    });

    const option = {
      backgroundColor: 'transparent',
      grid: { left: 0, right: 0, top: 0, bottom: 0 },
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(15, 23, 42, 0.96)',
        borderWidth: 0,
        padding: 12,
        textStyle: { color: '#f9fafb' },
        extraCssText: 'box-shadow:0 12px 30px rgba(15,23,42,0.55);border-radius:8px;',
        formatter: (p) => {
          const d = p.data._raw;
          const warn = (d.stage != null && d.stage > 100) ? '（回升）' : '';
          return `
            <div style="font-weight:600;margin-bottom:6px;">${d.name}${warn}</div>
            <div>总数：<b>${fmtNum(d.total)}</b></div>
            <div>阶段转化：<b>${fmtPct(d.stage)}</b></div>
            <div>总转化：<b>${fmtPct(d.overall)}</b></div>
          `;
        }
      },
      series: [
        {
          name: '客户转化漏斗',
          type: 'funnel',
          // 图表主体：名称放图内；指标单独用辅助层在外侧
          left: '15%',
          right: '15%',
          top: 50,
          bottom: 20,
          min: raw[raw.length - 1].total,
          max: raw[0].total,
          minSize: '5%',    // 大幅减小最小尺寸，更好体现小数值
          maxSize: '95%',   // 略微增加最大尺寸
          // 保持与右侧指标卡片一致：按数据顺序展示（不按数值自动排序）
          sort: 'none',
          gap: 10,
          funnelAlign: 'center',
          label: {
            show: false  // 不在图表内显示名称，移到外面统一显示
          },
          labelLine: { show: false },
          itemStyle: {
            borderColor: '#ffffff',
            borderWidth: 2,
            shadowBlur: 16,
            shadowColor: 'rgba(15,23,42,0.08)'
          },
          emphasis: {
            itemStyle: { shadowBlur: 24, shadowColor: 'rgba(15,23,42,0.16)' }
          },
          data: raw.map((d, i) => {
            const isRise = d.stage != null && d.stage > 100;
            return {
              name: d.name,
              value: d.total,
              itemStyle: {
                color: colors[i % colors.length],
                borderColor: '#ffffff',
                borderWidth: 2,
                ...(isRise ? { borderColor: 'rgba(245, 158, 11, 0.75)', borderWidth: 3 } : {})
              },
              _raw: d
            };
          })
        },
        // 辅助层：仅用于在图表外显示数量/转化率，图形透明
        {
          name: '指标标签',
          type: 'funnel',
          silent: true,
          z: 5,
          left: '15%',
          right: '15%',
          top: 50,
          bottom: 20,
          min: raw[raw.length - 1].total,
          max: raw[0].total,
          minSize: '5%',    // 与主图层保持一致
          maxSize: '95%',   // 与主图层保持一致
          sort: 'none',
          gap: 10,
          funnelAlign: 'center',
          label: {
            show: true,
            position: 'left',
            align: 'right',
            verticalAlign: 'middle',
            formatter: (p) => {
              const d = p.data._raw;
              return `{n|${d.name}}\n{m|数量：${fmtNum(d.total)}}\n{m|阶段转化：${fmtPct(d.stage)} · 总转化：${fmtPct(d.overall)}}`;
            },
            rich: {
              n: { 
                fontSize: 12, 
                fontWeight: 700, 
                color: '#111827', 
                lineHeight: 18,
                padding: [2, 0]
              },
              m: { 
                fontSize: 11, 
                color: '#4b5563', 
                lineHeight: 16 
              }
            }
          },
          labelLine: {
            show: true,
            length: 60,  // 增加长度让文字离图表更远
            smooth: 0.1,
            lineStyle: { color: '#cbd5e1', width: 1 }
          },
          itemStyle: {
            color: 'transparent',
            borderColor: 'transparent'
          },
          emphasis: { disabled: true },
          data: raw.map((d) => ({
            name: d.name,
            value: d.total,
            _raw: d
          }))
        }
      ]
    };

    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
  </script>
</body>
</html>